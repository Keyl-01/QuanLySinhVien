
{% extends "layouts/base.html" %}

{% block title %} Thông tin cá nhân {% endblock %} 

<!-- Specific CSS goes HERE -->
{% block stylesheets %}
{% endblock stylesheets %}

{% block content %}

<div class="pcoded-content pt-2">
    <div class="pcoded-inner-content">
        <div class="main-body">
            <div class="page-wrapper">
                <!-- [ breadcrumb ] start -->
                <div class="page-header">
                    <div class="page-block">
                        <div class="row align-items-center">
                            <div class="col-md-12">
                                <div class="page-header-title">
                                    <h5 class="m-b-10">Thông tin cá nhân</h5>
                                </div>
                                <ul class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="/"><i class="feather icon-home"></i></a></li>
                                    <li class="breadcrumb-item"><a href="#!">Thông tin cá nhân</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- [ breadcrumb ] end -->
                <!-- [ Main Content ] start -->
                <div class="row">
                    <!-- [ sample-page ] start -->
                    <div class="col-lg-4">
                        <div class="card user-card user-card-1">
                            <div class="card-body pb-0">
                                <!-- <div class="float-end">
                                    <span class="badge badge-success">Pro</span>
                                </div> -->
                                <div class="media user-about-block align-items-center mt-0 mb-3">
                                    <div class="position-relative d-inline-block">
                                        <img class="img-radius img-fluid wid-80" src="https://appsrv1-147a1.kxcdn.com/datta-able-pro-v100/images/user/avatar-2.jpg" alt="User image">
                                        <div class="certificated-badge">
                                            <!-- <i class="fas fa-certificate text-primary bg-icon"></i>
                                            <i class="fas fa-check front-icon text-white"></i> -->
                                        </div>
                                    </div>
                                    <div class="media-body ms-3">
                                        <h6 class="mb-1">
                                            {{ current_user.username + ' - ' + current_user.last_name + ' ' + current_user.first_name }}
                                        </h6>
                                        <!-- <p class="mb-0 text-muted">UI/UX Designer</p> -->
                                    </div>
                                </div>
                            </div>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">
                                    <span class="f-w-500"><i class="feather icon-mail m-r-10"></i>Email</span>
                                    <div class="float-right text-body">
                                        {{ current_user.email }}
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <span class="f-w-500"><i class="feather icon-phone-call m-r-10"></i>Số điện thoại</span>
                                    <div href="#" class="float-right text-body">{{ current_user.phone }}</div>
                                </li>
                                <li class="list-group-item border-bottom-0">
                                    <!-- <span class="f-w-500"><i class="feather icon-map-pin m-r-10"></i>Location</span>
                                    <span class="float-end">Melbourne</span> -->
                                </li>
                            </ul>
                            <div class="nav flex-column nav-pills list-group list-group-flush list-pills" id="user-set-tab" role="tablist" aria-orientation="vertical">
                                <a class="nav-link list-group-item list-group-item-action active" id="user-set-profile-tab" data-toggle="pill" href="#user-set-profile" role="tab" aria-controls="user-set-profile" aria-selected="false">
                                    <span class="f-w-500"><i class="feather icon-user m-r-10 h5 "></i>Thông tin cá nhân</span>
                                    <span class="float-right"><i class="feather icon-chevron-right"></i></span>
                                </a>
                                <a class="nav-link list-group-item list-group-item-action" id="user-set-passwort-tab" data-toggle="pill" href="#user-set-passwort" role="tab" aria-controls="user-set-passwort" aria-selected="true">
                                    <span class="f-w-500"><i class="feather icon-shield m-r-10 h5 "></i>Đổi mật khẩu</span>
                                    <span class="float-right"><i class="feather icon-chevron-right"></i></span>
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <div class="tab-content bg-transparent p-0 shadow-none" id="user-set-tabContent">
                            <div class="tab-pane fade active show" id="user-set-profile" role="tabpanel" aria-labelledby="user-set-profile-tab">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="feather icon-user text-c-blue wid-20"></i><span class="p-l-5">Thông tin cá nhân</span></h5>
                                    </div>
                                    <div class="card-body px-4 pt-4 pb-0">
                                        <form id="formNV" class="form-edit" role="form" method="POST">
                                            {{ form.hidden_tag() }}
                                            <div class="row">
                                                <div class="form-group col-md-12">
                                                    <div class="form-group d-flex w-100 mb-2">
                                                        <div class="fieldLabel d-flex justify-content-end align-items-top col-3 pt-2 pr-1">
                                                            <small class="text-danger mr-1">*</small>{{ form.ma_nv.label(class="text-dark") }}
                                                        </div>
                                                        <div class="fieldName pr-0 col-8 align-self-end">
                                                            {{ form.ma_nv(class="form-control bg-white shadow-none", style="padding: 6px 12px;") }}
                                                            <small id="ifb_ma_nv" class="invalid-feedback text-danger position-absolute text-truncate">Mã nhân viên là trường bắt buộc.</small>
                                                        </div>
                                                    </div>
                                                </div>
                    
                                                <div class="form-group col-md-12">
                                                    <div class="form-group d-flex w-100 mb-2">
                                                        <div class="fieldLabel d-flex justify-content-end align-items-top col-3 pt-2 pr-1">
                                                            <small class="text-danger mr-1">*</small>{{ form.first_name.label(class="text-dark") }}
                                                        </div>
                                                        <div class="fieldName pr-0 col-8 align-self-end">
                                                            {{ form.first_name(class="form-control bg-white shadow-none", style="padding: 6px 12px;") }}
                                                            <small id="ifb_first_name" class="invalid-feedback text-danger position-absolute text-truncate">Tên nhân viên là trường bắt buộc.</small>
                                                        </div>
                                                    </div>
                                                </div>
                    
                                                <div class="form-group col-md-12">
                                                    <div class="form-group d-flex w-100 mb-2">
                                                        <div class="fieldLabel d-flex justify-content-end align-items-top col-3 pt-2 pr-1">
                                                            <small class="text-danger mr-1">*</small>{{ form.last_name.label(class="text-dark") }}
                                                        </div>
                                                        <div class="fieldName pr-0 col-8 align-self-end">
                                                            {{ form.last_name(class="form-control bg-white shadow-none", style="padding: 6px 12px;") }}
                                                            <small id="ifb_last_name" class="invalid-feedback text-danger position-absolute text-truncate">Họ đệm nhân viên là trường bắt buộc.</small>
                                                        </div>
                                                    </div>
                                                </div>
                    
                                                <div class="form-group col-md-12">
                                                    <div class="form-group d-flex w-100 mb-2">
                                                        <div class="fieldLabel d-flex justify-content-end align-items-top col-3 pt-2 pr-1">
                                                            <small class="text-danger mr-1">*</small>{{ form.date_birth.label(class="text-dark") }}
                                                        </div>
                                                        <div class="fieldName pr-0 col-5 align-self-end">
                                                            {{ form.date_birth(class="form-control bg-white shadow-none", style="padding: 6px 12px;") }}
                                                            <small id="ifb_date_birth" class="invalid-feedback text-danger position-absolute text-truncate">Ngày sinh là trường bắt buộc.</small>
                                                        </div>
                                                    </div>
                                                </div>
                    
                                                <div class="form-group col-md-12">
                                                    <div class="form-group d-flex w-100 mb-2">
                                                        <div class="fieldLabel d-flex justify-content-end align-items-top col-3 pt-2 pr-1">
                                                            <small class="text-danger mr-1">*</small>{{ form.email.label(class="text-dark") }}
                                                        </div>
                                                        <div class="fieldName pr-0 col-5 align-self-end">
                                                            {{ form.email(class="form-control bg-white shadow-none", style="padding: 6px 12px;") }}
                                                            <small id="ifb_email" class="invalid-feedback text-danger position-absolute text-truncate"></small>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="form-group col-md-12">
                                                    <div class="form-group d-flex w-100 mb-2">
                                                        <div class="fieldLabel d-flex justify-content-end align-items-top col-3 pt-2 pr-1">
                                                            <small class="text-danger mr-1">*</small>{{ form.phone.label(class="text-dark") }}
                                                        </div>
                                                        <div class="fieldName pr-0 col-5 align-self-end">
                                                            {{ form.phone(class="form-control bg-white shadow-none", style="padding: 6px 12px;") }}
                                                            <small id="ifb_phone" class="invalid-feedback text-danger position-absolute text-truncate">Số điện thoại là trường bắt buộc.</small>
                                                        </div>
                                                    </div>
                                                </div>
                    
                                                <div class="form-group col-md-12">
                                                    <div class="form-group d-flex w-100 mb-2">
                                                        <div class="fieldLabel d-flex justify-content-end align-items-top col-3 pt-2 pr-1">
                                                            {{ form.address.label(class="text-dark") }}
                                                        </div>
                                                        <div class="fieldName pr-0 col-5 align-self-end">
                                                            {{ form.address(class="form-control bg-white shadow-none", style="padding: 6px 12px;") }}
                                                        </div>
                                                    </div>
                                                </div>
                    
                                                <div class="form-group col-md-12">
                                                    <div class="form-group d-flex w-100 mb-2">
                                                        <div class="fieldLabel d-flex justify-content-end align-items-top col-3 pt-2 pr-1">
                                                            {{ form.xa.label(class="text-dark") }}
                                                        </div>
                                                        <div class="fieldName pr-0 col-5 align-self-end">
                                                            {{ form.xa(class="form-control bg-white shadow-none", style="padding: 6px 12px;") }}
                                                        </div>
                                                    </div>
                                                </div>
                    
                                                <div class="form-group col-md-12">
                                                    <div class="form-group d-flex w-100 mb-2">
                                                        <div class="fieldLabel d-flex justify-content-end align-items-top col-3 pt-2 pr-1">
                                                            {{ form.quan.label(class="text-dark") }}
                                                        </div>
                                                        <div class="fieldName pr-0 col-5 align-self-end">
                                                            {{ form.quan(class="form-control bg-white shadow-none", style="padding: 6px 12px;") }}
                                                        </div>
                                                    </div>
                                                </div>
                    
                                                <div class="form-group col-md-12">
                                                    <div class="form-group d-flex w-100 mb-2">
                                                        <div class="fieldLabel d-flex justify-content-end align-items-top col-3 pt-2 pr-1">
                                                            {{ form.city.label(class="text-dark") }}
                                                        </div>
                                                        <div class="fieldName pr-0 col-5 align-self-end">
                                                            {{ form.city(class="form-control bg-white shadow-none", style="padding: 6px 12px;") }}
                                                        </div>
                                                    </div>
                                                </div>
                    
                                                <div class="form-group col-md-12">
                                                    <div class="form-group d-flex w-100 mb-2">
                                                        <div class="fieldLabel d-flex justify-content-end align-items-top col-3 pt-2 pr-1">
                                                            {{ form.type.label(class="text-dark") }}
                                                        </div>
                                                        <div class="fieldName pr-0 col-5 align-self-end">
                                                            {{ form.type(class="form-control bg-white shadow-none", style="padding: 6px 12px;") }}
                                                        </div>
                                                    </div>
                                                </div>
                    
                                            </div>
                                        </form>
                                    </div>
                                    <div class="card-footer p-3">
                                        <button class="btn btn-primary float-right m-0 mr-1 saveNV" data-id="{{ current_user.id }}">Lưu</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="user-set-passwort" role="tabpanel" aria-labelledby="user-set-passwort-tab">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i data-feather="lock" class="icon-svg-primary wid-20"></i><span class="p-l-5">Đổi mật khẩu</span></h5>
                                    </div>
                                    <div class="card-body px-4 pt-4 pb-0">
                                        <form id="formTK" class="form-edit" role="form" method="POST">
                                            {{ form.hidden_tag() }}
                                            <div class="row">
                                                <div class="form-group col-md-12">
                                                    <div class="form-group d-flex w-100 mb-2">
                                                        <div class="fieldLabel d-flex justify-content-end align-items-top col-3 pt-2 pr-1">
                                                            <small class="text-danger mr-1">*</small>{{ form.username.label(class="text-dark") }}
                                                        </div>
                                                        <div class="fieldName pr-0 col-7 align-self-end">
                                                            {{ form.username(class="form-control bg-white shadow-none", style="padding: 6px 12px;", disabled="disabled") }}
                                                            <!-- <small id="ifb_username" class="invalid-feedback text-danger position-absolute text-truncate">Mã nhân viên là trường bắt buộc.</small> -->
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="form-group col-md-12">
                                                    <div class="form-group d-flex w-100 mb-2">
                                                        <div class="fieldLabel d-flex justify-content-end align-items-top col-3 pt-2 pr-1">
                                                            <small class="text-danger mr-1">*</small>{{ form.current_password.label(class="text-dark") }}
                                                        </div>
                                                        <div class="fieldName pr-0 col-7 align-self-end">
                                                            {{ form.current_password(class="form-control bg-white shadow-none", style="padding: 6px 12px;") }}
                                                            <small id="ifb_current_password" class="invalid-feedback text-danger position-absolute text-truncate">Mật khẩu hiện tại là trường bắt buộc.</small>
                                                        </div>
                                                    </div>
                                                </div>
                    
                                                <div class="form-group col-md-12">
                                                    <div class="form-group d-flex w-100 mb-2">
                                                        <div class="fieldLabel d-flex justify-content-end align-items-top col-3 pt-2 pr-1">
                                                            <small class="text-danger mr-1">*</small>{{ form.password.label(class="text-dark") }}
                                                        </div>
                                                        <div class="fieldName pr-0 col-7 align-self-end">
                                                            {{ form.password(class="form-control bg-white shadow-none", style="padding: 6px 12px;") }}
                                                            <small id="ifb_password" class="invalid-feedback text-danger position-absolute text-truncate">Mật khẩu là trường bắt buộc.</small>
                                                        </div>
                                                    </div>
                                                </div>
                    
                                                <div class="form-group col-md-12">
                                                    <div class="form-group d-flex w-100 mb-2">
                                                        <div class="fieldLabel d-flex justify-content-end align-items-top col-3 pt-2 pr-1">
                                                            <small class="text-danger mr-1">*</small>{{ form.confirm_password.label(class="text-dark") }}
                                                        </div>
                                                        <div class="fieldName pr-0 col-7 align-self-end">
                                                            {{ form.confirm_password(class="form-control bg-white shadow-none", style="padding: 6px 12px;") }}
                                                            <small id="ifb_confirm_password" class="invalid-feedback text-danger position-absolute text-truncate">Xác nhận mật khẩu là trường bắt buộc.</small>
                                                            <small id="ifb_confirm_password_check" class="invalid-feedback text-danger position-absolute text-truncate">Mật khẩu không trùng khớp.</small>
                                                        </div>
                                                    </div>
                                                </div>
                    
                                            </div>
                                        </form>
                                    </div>
                                    <div class="card-footer p-3">
                                        <button class="btn btn-primary float-right m-0 mr-1 saveTK" data-id="{{ current_user.id }}">Đổi mật khẩu</button>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    <!-- [ sample-page ] end -->
                </div>
                <!-- [ Main Content ] end -->
            </div>
        </div>
    </div>

    <!-- Modal Alert -->
    <div class="modal fade" id="alertModal" tabindex="-1" role="dialog" aria-labelledby="alertModalLabel" aria-modal="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content rounded" role="document">
                <div class="modal-header d-flex align-items-center shadow-sm px-4 py-3">
                    <h5 class="modal-title font-weight-bold" id="alertModalLabel">Thông báo trùng lặp</h5>
                    <button type="button" class="close btn btn-lg" data-dismiss="modal" aria-label="Close">
                        <h3 class="m-0" aria-hidden="true">&times;</h3>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="p-2" id="msg"></div>
                </div>
                <div class="modal-footer" style="padding: 12px 24px;">
                    <!-- <button type="button" name="insert_data" id="btn_save" data-dismiss="modal" class="btn btn-primary btn-sm m-0">OK</button> -->
                    <button type="button" data-dismiss="modal" class="btn btn-primary btn-sm m-0">OK</button>
                </div>
            </div>
        </div>
    </div>

</div>

{% endblock content %}

{% block javascripts %}

    <script>
        $(document).ready(function () {

            // call function invalid-feedback
            invalidFeedback('#ma_nv', '#ifb_ma_nv');
            invalidFeedback('#first_name', '#ifb_first_name');
            invalidFeedback('#last_name', '#ifb_last_name');
            invalidFeedback('#date_birth', '#ifb_date_birth');
            invalidFeedbackEmail();
            invalidFeedback('#phone', '#ifb_phone');
            
            

            // Event click the save button to add new
            $('.saveNV').on('click', function(){
                var id = $(this).attr("data-id");
                saveForm(id, 'PUT');
            });


            // Function save form
            function saveForm(id, method){
                var ma_nv = $('#ma_nv').val();
                var first_name = $('#first_name').val();
                var last_name = $('#last_name').val();
                var date_birth = $('#date_birth').val();
                var email = $('#email').val();
                var phone = $('#phone').val();
                var address = $('#address').val();
                var xa = $('#xa').val();
                var quan = $('#quan').val();
                var city = $('#city').val();
                var type = $('#type').val();

                // alert(first_name)
                if(ma_nv=='' || first_name=='' || last_name=='' || email=='' || phone=='' || date_birth=='' || type==null){
                    checkInput('#ma_nv', '#ifb_ma_nv');
                    checkInput('#first_name', '#ifb_first_name');
                    checkInput('#last_name', '#ifb_last_name');
                    checkInput('#date_birth', '#ifb_date_birth');
                    // checkInputEmail('#email', '#ifb_email');
                    checkInputEmail();
                    checkInput('#phone', '#ifb_phone');
                }else{
                    if(method!='POST'){id='/'+id;}
                    $.ajax({
                        url: '/profilenv'+id,
                        type: method,
                        data: {ma_nv: ma_nv, 
                            first_name: first_name, 
                            last_name: last_name, 
                            date_birth: date_birth,
                            email: email,
                            phone: phone,
                            address: address,
                            xa: xa,
                            quan: quan,
                            city: city,
                            type: type
                        },
                        success: function(data){
                            if(data.duplicate){
                                showAlertModal('Thông báo trùng lặp', data.duplicate);
                            }else if(data.success){
                                location.reload();

                                // notify('top', 'right', '', 'success', 'animated fadeIn', 'animated fadeOut', data.success);
                                // setInputValue();
                            }
                        }
                    });
                }
            }

            // Call api
            function setInputValue() {
                var id = $('.saveNV').attr("data-id");
                $.ajax({
                    url: '/api/nhanvien/info',
                    type: 'POST',
                    data: {id: id},
                    success: function(data){
                        if(data.data){
                            // Set input value
                            $('#ma_nv').val(data.data.ma_nv);
                            $('#first_name').val(data.data.first_name);
                            $('#last_name').val(data.data.last_name);
                            $('#date_birth').val(data.data.date_birth);
                            $('#email').val(data.data.email);
                            $('#phone').val(data.data.phone);
                            $('#address').val(data.data.address);
                            $('#xa').val(data.data.xa);
                            $('#quan').val(data.data.quan);
                            $('#city').val(data.data.city);
                            $("#type").val(data.data.type).trigger('change');

                            $('#username').val(data.data.username);
                            
                        }else if(data.error){
                            notify('top', 'right', '', 'danger', 'animated fadeIn', 'animated fadeOut', data.error);
                        }
                    }
                });
            }
            setInputValue();
            

            



            invalidFeedbackPassword();
            invalidFeedback('#current_password', '#ifb_current_password');
            invalidFeedback('#password', '#ifb_password');
            
            $('#password').on('keyup', function(){
                checkInputPassword();
            });
            $('#confirm_password').on('keyup', function(){
                // alert('keyup');
                checkInputPassword();
            });

            // Reset form when close modal
            // $('button.closeFormModalTK').on('click', function(){
            //     $('#formTK').trigger('reset');
            //     $('input').css('border', '');
            //     $('.select2-selection').css('border', '');
            //     $('small.invalid-feedback').hide('');
            // });

            // Event click the save button to edit
            $('.saveTK').on('click', function(){
                var id = $(this).attr("data-id");
                saveFormTK(id, 'PUT');
            });

            // Function save form TK
            function saveFormTK(id, method){
                var current_password = $('#current_password').val();
                var password = $('#password').val();
                var confirm_password = $('#confirm_password').val();
                if(current_password=='' || password=='' || confirm_password=='' || password!=confirm_password){
                    checkInputPassword();
                    checkInput('#current_password', '#ifb_current_password');
                    checkInput('#password', '#ifb_password');
                    // checkInput('#confirm_password', '#ifb_confirm_password');
                }else{
                    if(method!='POST'){id='/'+id;}
                    $.ajax({
                        url: '/changepass'+id,
                        type: method,
                        data: {current_password: current_password, password: password},
                        success: function(data){
                            if(data.duplicate){
                                showAlertModal('Mật khẩu hiện tại không chính xác', data.duplicate);
                            }else if(data.success){
                                location.reload();
                                // notify('top', 'right', '', 'success', 'animated fadeIn', 'animated fadeOut', data.success);
                            }
                        }
                    });
                }
            }



        });
    </script>

{% endblock javascripts %}